<!DOCTYPE html>
<html lang="en">
{% load static %}
<head>
    <meta charset="UTF-8">
    <title>疫情周报</title>
    <script src="{% static 'js/jquery.min.js' %}"></script>
    <link href="{% static 'css/bootstrap.min.css' %}" rel="stylesheet">
    <script src="{% static 'js/bootstrap.min.js' %}"></script>
    <script src="{% static 'js/echarts.js' %}"></script>
    <script src="{% static 'js/world.js' %}"></script>
    <script src="{% static 'js/charts.js' %}"></script>
    <script src="{% static 'js/handle_data.js' %}"></script>
    <script src="{% static 'js/d3.v4.min.js' %}"></script>

    <link href="{% static 'css/ladda-themeless.min.css' %}" rel="stylesheet">
    <script type="text/javascript" src="{% static 'js/spin.min.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/ladda.min.js' %}"></script>

    <style>
        h3 {
            margin-top: 25px;
            margin-bottom: 30px;
        }
        div {
            margin-bottom: 15px;
        }
        font {
            color: red;
            font-weight: bold;
        }
        .red {
            background-color: lightcoral;
        }
        .green {
            background-color: lightgreen;
        }
        .last {
            margin-bottom: 45px;
        }
    </style>
</head>
<body>
<div class="container">
    <div style="position: fixed; right: 60px; margin-top: 25px;">
        <a id="download" href="{% static 'report/report.docx' %}"></a>
        <button id="create_btn" class="btn btn-info ladda-button" data-style="zoom-out" onclick="createReport()">生成疫情周报</button>
        <br>
        <button class="btn btn-warning" style="margin-top: 10px;" onclick="showMissingCountries()">查看忽略国家</button>
        <br>
        <button class="btn btn-primary" style="margin-top: 10px;" onclick="deleteFiles()">清空后端文件</button>
    </div>
    <div>
        <h3>全局设置</h3>
        <div>2-16 新增确诊人数增速过滤百分比 <input type="text" value="0.2" id="filter_cases"></div>
        <div>2-17 新增病死人数增速过滤百分比 <input type="text" value="0.1" id="filter_death"></div>
        <button class="btn btn-primary" onclick="refresh_charts()">刷新</button> &nbsp;&nbsp; <span class="invisible" style="color: red" id="after_refresh">刷新成功！</span>
    </div>
    <div>
{#        注：<span class="red">红色背景表示新增</span>，<span class="green">绿色背景表示修改</span><br>#}
        <h3>一周疫情关键数据（<span class="start_date_month"><font>&nbsp;Null&nbsp;</font></span>月<span class="start_date_day"><font>&nbsp;Null&nbsp;</font></span>日
            —<span class="end_date_month"><font>&nbsp;Null&nbsp;</font></span>月<span class="end_date_day"><font>&nbsp;Null&nbsp;</font></span>日）</h3>
        ——当前全球确诊数量：<span class="2"><font>&nbsp;Null&nbsp;</font></span>例 <br>
        ——当前全球病死数量：<span class="3"><font>&nbsp;Null&nbsp;</font></span>例 <br>
        ——当前全球确诊率：<span class="4"><font>&nbsp;Null&nbsp;</font></span> <br>
        ——当前全球病死率：<span class="5"><font>&nbsp;Null&nbsp;</font></span> <br>
        ——当前全球确诊最多国家：<span class="6"><font>&nbsp;Null&nbsp;</font></span>（<span class="7"><font>&nbsp;Null&nbsp;</font></span>例）、<span class="8"><font>&nbsp;Null&nbsp;</font></span>（<span class="9"><font>&nbsp;Null&nbsp;</font></span>例） <br>
        ——当前全球病死最多国家：<span class="10"><font>&nbsp;Null&nbsp;</font></span>（<span class="11"><font>&nbsp;Null&nbsp;</font></span>例）、<span class="12"><font>&nbsp;Null&nbsp;</font></span>（<span class="13"><font>&nbsp;Null&nbsp;</font></span>例） <br>

        ——上周全球确诊<span class="14"><font>&nbsp;Null&nbsp;</font></span>例，比前一周<span class="15"><font>&nbsp;Null&nbsp;</font></span> <br>
        ——上周全球病死<span class="16"><font>&nbsp;Null&nbsp;</font></span>例，比前一周<span class="17"><font>&nbsp;Null&nbsp;</font></span> <br>
        ——上周确诊最多国家：<span class="18"><font>&nbsp;Null&nbsp;</font></span>（<span class="19"><font>&nbsp;Null&nbsp;</font></span>例）、<span class="20"><font>&nbsp;Null&nbsp;</font></span>（<span class="21"><font>&nbsp;Null&nbsp;</font></span>例） <br>
        ——上周病死最多国家：<span class="22"><font>&nbsp;Null&nbsp;</font></span>（<span class="23"><font>&nbsp;Null&nbsp;</font></span>例）、<span class="24"><font>&nbsp;Null&nbsp;</font></span>（<span class="25"><font>&nbsp;Null&nbsp;</font></span>例） <br>
        ——上周确诊增速最快国家：<span class="26"><font>&nbsp;Null&nbsp;</font></span>（<span class="27"><font>&nbsp;Null&nbsp;</font></span>）、<span class="28"><font>&nbsp;Null&nbsp;</font></span>（<span class="29"><font>&nbsp;Null&nbsp;</font></span>） <br>
        ——上周病死增速最快国家：<span class="30"><font>&nbsp;Null&nbsp;</font></span>（<span class="31"><font>&nbsp;Null&nbsp;</font></span>）、<span class="32"><font>&nbsp;Null&nbsp;</font></span>（<span class="33"><font>&nbsp;Null&nbsp;</font></span>） <br>
    </div>
    <div class="text_to_save">
        <div>
            <h3>全球疫情发展大数据分析周报</h3>
            （<span class="start_date_month"><font>&nbsp;Null&nbsp;</font></span>月<span class="start_date_day"><font>&nbsp;Null&nbsp;</font></span>日—<span class="end_date_month"><font>&nbsp;Null&nbsp;</font></span>月<span class="end_date_day"><font>&nbsp;Null&nbsp;</font></span>日）
            <br>
            2020年<span class="end_date_month"><font>&nbsp;Null&nbsp;</font></span>月<span class="end_date_day"><font>&nbsp;Null&nbsp;</font></span>日
            <br>
            <h3>本周疫情要点</h3>
            全球累计确诊已达<span class="wan_2"><font>&nbsp;Null&nbsp;</font></span>万，病死<span class="wan_3"><font>&nbsp;Null&nbsp;</font></span>万。<br>
            全球本周确诊<span class="14"><font>&nbsp;Null&nbsp;</font></span>例，新增确诊较上周<span class="15"><font>&nbsp;Null&nbsp;</font></span>。<br>
            全球本周病死<span class="16"><font>&nbsp;Null&nbsp;</font></span>例，新增病死较上周<span class="17"><font>&nbsp;Null&nbsp;</font></span>。<br>
            注：本报告所有疫情数据截至<span class="end_date_month"><font>&nbsp;Null&nbsp;</font></span>月<span class="end_date_day"><font>&nbsp;Null&nbsp;</font></span>日<span class="36"><font>&nbsp;Null&nbsp;</font></span>时<span class="37"><font>&nbsp;Null&nbsp;</font></span>分，中国数据包含港澳台，法国数据不包括养老院数据，美国数据包括其军队、监狱、境外特殊输入病例等数据。
        </div>
        <h3>2.&nbsp;全球疫情现况</h3>
        <h3>2.1&nbsp;全球累计确诊：<span class="2"><font>&nbsp;Null&nbsp;</font></span>例，病死：<span class="3"><font>&nbsp;Null&nbsp;</font></span>例</h3>
        主要分布在<span class="2_1_countries"><font>&nbsp;Null&nbsp;</font></span>。
        <div id="2_1" style="width: 800px;height:470px;"></div>
        <div>图 2-1&nbsp;全球累计确诊分布图</div>
        <div id="2_2" style="width: 800px;height:470px;"></div>
        <div>图 2-2&nbsp;全球累计病死分布图</div>
        <hr>
        <div class="row" style="width: 800px;">
            <div id="2_3_a" class="col-6" style="margin: 0; padding: 0; height: 230px;"></div>
            <div id="2_3_b" class="col-6" style="margin: 0; padding: 0; height: 230px;"></div>
            <div class="col-6" style="text-align: center;">(a)</div>
            <div class="col-6" style="text-align: center;">(b)</div>
            <div>图2-3&nbsp;全球累计确诊人数增长曲线（a）、累计病死人数增长曲线（b）</div>
        </div>
        <div class="row" style="width: 800px;">
            <div id="2_4_a" class="col-6" style="margin: 0; padding: 0; height: 230px;"></div>
            <div id="2_4_b" class="col-6" style="margin: 0; padding: 0; height: 230px;"></div>
            <div class="col-6" style="text-align: center;">(a)</div>
            <div class="col-6" style="text-align: center;">(b)</div>
            <div>图2-4&nbsp;全球确诊率增长曲线（a）、病死率增长曲线（b）</div>
            <div>注：确诊率为累计确诊人数占总人口的百分比，病死率为累计病死人数占累计确诊人数的百分比。</div>
        </div>
        
        <div class="row" style="width: 800px;">
            <div id="2_5_a" class="col-6" style="margin: 0; padding: 0; height: 230px;"></div>
            <div id="2_5_b" class="col-6" style="margin: 0; padding: 0; height: 230px;"></div>
            <div class="col-6" style="text-align: center;">(a)</div>
            <div class="col-6" style="text-align: center;">(b)</div>
            <div>图2-5&nbsp;全球新增确诊人数增长曲线（a）、新增病死人数增长曲线（b）</div>
        </div>
        
        <div id="2_6" style="width: 850px;height:430px;"></div>
        <div>图 2-6&nbsp;全球累计确诊人数来源构成（显示前15个国家）</div>
        <div id="2_7" style="width: 850px;height:430px;"></div>
        <div>图 2-7&nbsp;全球累计病死人数来源构成（显示前15个国家）</div>

        <!--<h3>2.2 全球本周新增确诊<span class="14"><font>&nbsp;Null&nbsp;</font></span>例，病死：<span class="16"><font>&nbsp;Null&nbsp;</font></span>例</h3>-->
        <h3>2.2&nbsp;全球确诊率：<span class="4"><font>&nbsp;Null&nbsp;</font></span>，病死率：<span class="5"><font>&nbsp;Null&nbsp;</font></span></h3>
        <div id="2_8" style="width: 800px;height:1900px;"></div>
        <div>图2-8&nbsp;各国确诊率（确诊率为累计确诊人数占总人口的百分比，仅显示累计确诊人数超过3000的国家中确诊率前50个国家）</div>
        <div id="2_9" style="width: 800px;height:1900px;"></div>
        <div>图2-9&nbsp;各国病死率（病死率为累计病死人数占累计确诊人数的百分比，仅显示累计确诊人数超过3000的国家中病死率前50个国家）</div>
        <div id="2_10" style="width: 800px;height:1900px;"></div>
        <div>图2-10&nbsp;各国治愈率（治愈率为累计治愈数占累计确诊人数的百分比，仅显示累计确诊人数超过3000的国家中治愈率前50个国家，部分国家数据更新不及时）</div>

        <div id="2_11" style="width: 800px;height:1900px;"></div>
        <div>图2-11&nbsp;各国检测率（检测率为累计检测数占总人口的百分比，仅显示累计确诊人数超过3000的国家中检测率前50个国家，部分国家数据更新不及时）</div>
        <div id="2_12" style="width: 800px;height:1900px;"></div>
        <div>图2-12&nbsp;各国阳性率（阳性率为累计确诊人数占累计检测数的百分比，仅显示累计确诊人数超过3000的国家中阳性率前50个国家，部分国家数据更新不及时）</div>

        <h3>2.3&nbsp;全球本周新增确诊：<span class="14"><font>&nbsp;Null&nbsp;</font></span>例，病死：<span class="16"><font>&nbsp;Null&nbsp;</font></span>例</h3>
        <div class="row" style="width: 800px;">
            <div id="2_13_a" class="col-6" style="margin: 0; padding: 0; height: 230px;"></div>
            <div id="2_13_b" class="col-6" style="margin: 0; padding: 0; height: 230px;"></div>
            <div class="col-6" style="text-align: center;">(a)</div>
            <div class="col-6" style="text-align: center;">(b)</div>
            <div>图2-13&nbsp;全球本周新增确诊人数增长曲线（a）、新增病死人数增长曲线（b）</div>
        </div>
        <h3>2.4&nbsp;全球本周新增确诊主要来源：<span class="18"><font>&nbsp;Null&nbsp;</font></span>、<span class="20"><font>&nbsp;Null&nbsp;</font></span></h3>
        <div id="2_14" style="width: 850px;height:430px;"></div>
        <div>图2-14&nbsp;全球本周新增确诊人数来源构成（显示前15个国家）</div>

        <h3>2.5&nbsp;全球本周新增病死主要来源：<span class="22"><font>&nbsp;Null&nbsp;</font></span>、<span class="24"><font>&nbsp;Null&nbsp;</font></span></h3>
        <div id="2_15" style="width: 850px;height:430px;"></div>
        <div>图2-15&nbsp;全球本周新增病死人数来源构成（显示前15个国家）</div>

        <h3>2.6&nbsp;本周新增确诊增长最快：<span class="26"><font>&nbsp;Null&nbsp;</font></span>，新增病死增长最快：<span class="30"><font>&nbsp;Null&nbsp;</font></span></h3>
        <div id="2_16" style="width: 800px;"></div>
        <div>图2-16&nbsp;本周较上周新增确诊人数增速（仅显示累计确诊人数超过1万且本周新增确诊人数超过500的国家中增速绝对值大于等于20%的国家）</div>
        <div>注：本周较上周新增确诊人数增速=（本周新增确诊人数-上周新增确诊人数）/上周新增确诊人数</div>

        <div id="2_17" style="width: 800px;"></div>
        <div>图2-17&nbsp;本周较上周新增病死人数增速（仅显示累计病死人数超过300且本周新增病死人数超过100的国家中增速绝对值大于等于20%的国家）</div>
        <div>注：本周较上周新增病死人数增速=（本周新增病死人数-上周新增病死人数）/上周新增病死人数</div>
        

        <h3>2.7&nbsp;附录</h3>
        <div id="2_18" style="width: 800px;height:1900px;"></div>
        <div>图2-18&nbsp;各国累计检测数（仅显示累计确诊人数超过3000的国家中累计检测数前50个国家，部分国家检测数据更新不及时）</div>

        <div id="2_19" style="width: 800px;height:550px;"></div>
        <div>图2-19&nbsp;全球215个国家地区单日新增确诊和新增治愈走势</div>
        <div id="2_20" style="width: 800px;height:550px;"></div>
        <div>图2-20&nbsp;“一带一路”65个国家地区单日新增确诊和新增治愈走势</div>
        <div id="2_21" style="width: 800px;height:550px;"></div>
        <div>图2-21&nbsp;非洲52个国家地区单日新增确诊和新增治愈走势</div>
        <div id="2_22" style="width: 800px;height:550px;"></div>
        <div>图2-22&nbsp;周边20个国家地区单日新增确诊和新增治愈走势</div>

        <div id="2_23" style="width: 800px;height:550px;"></div>
        <div>图2-23&nbsp;截至4月底处于上行阶段26个国家单日新增确诊和新增治愈走势</div>
        <div id="2_24" style="width: 800px;height:550px;"></div>
        <div>图2-24&nbsp;截至4月底处于震荡阶段28个国家单日新增确诊和新增治愈走势</div>
        <div id="2_25" style="width: 800px;height:550px;"></div>
        <div>图2-25&nbsp;截至4月底处于下行阶段28个国家单日新增确诊和新增治愈走势</div>
        <div id="2_26" style="width: 800px;height:550px;"></div>
        <div>图2-26&nbsp;截至4月底处于尾期阶段27个国家单日新增确诊和新增治愈走势</div>
        <!-- <div id="2_18" style="width: 800px;"></div>
        <div>
            图2-18&nbsp;本周较上周新增确诊人数增速（仅显示累计确诊人数超过1万的国家中增速绝对值大于等于20%的国家）<br>
            注：本周较上周新增确诊人数增速=（本周新增确诊人数-上周新增确诊人数）/上周新增确诊人数
        </div>
        <div id="2_19" style="width: 800px;"></div>
        <div>
            图2-19&nbsp;本周较上周新增病死人数增速（仅显示累计确诊人数超过1万的国家中增速绝对值大于等于20%的国家）<br>
            注：本周较上周新增病死人数增速=（本周新增病死人数-上周新增病死人数）/上周新增病死人数
        </div> -->
    </div>
</div>

<script>
    var countries = [];
    var ineffectiveCountries = [];
    var error_info = "{{ error_info }}";
    {% for country in missing_countries %}
        countries.push("{{country}}");
    {% endfor %}
    {% for country in ineffective_countries %}
        ineffectiveCountries.push("{{country}}");
    {% endfor %}
    var alertInfo = `
        缺失国家：${countries}
        错误国家：${ineffectiveCountries}
    `;
    if (countries.length || ineffectiveCountries.length){
        alert(alertInfo);
    }
    if (error_info){
        alert(error_info);
    }
    var rate_countries_num = 0;
    var imagesInfo = {};
    var text = "";
    var cases_3 = [];
    d3.csv("{% static export_dir|add:'basic_info.csv' %}", function (error, csvdata) {
        if(error){
            console.log(error);
        }else{
            // console.log(csvdata);
            let data_format = {
                date: [0,1],
                int_num: [2,3,7,9,11,13,14,16,19,21,23,25],
                int_wan: [2,3],
                percent_num: [4,5],
                percent_rate: [15,17],
                percent_int_num: [27,29,31,33],
                countries: [6,8,10,12,18,20,22,24,26,28,30,32],
                cases_3: [6,8,34],
                time: [36, 37]
            };
            let data = null;
            csvdata.forEach(function (value, index) {
                data = value.value;
                if (data_format.date.includes(index)){
                    data = new Date(data);
                     if (index){
                        $(".end_date_month").text(data.getMonth()+1);
                        $(".end_date_day").text(data.getDate());
                     }else{
                         $(".start_date_month").text(data.getMonth()+1);
                         $(".start_date_day").text(data.getDate());
                     }
                }else if (data_format.int_num.includes(index)){
                    if (data_format.int_wan.includes(index)){
                        $(".wan_"+index).text((data/10000).toFixed(1));
                    }
                    data = format_number(data)
                }else if (data_format.percent_num.includes(index)){
                    data = format_percent(data)
                }else if (data_format.percent_rate.includes(index)){
                    if (data > 0){
                        data = "上升" + Math.round(data * 100) + "%"
                    }else if (data < 0){
                        data = "下降" + Math.round(Math.abs(data) * 100) + "%"
                    }else{
                        data = "一致"
                    }
                }else if (data_format.percent_int_num.includes(index)){
                    data = Math.round(data * 100) + "%"
                }else if (data_format.cases_3.includes(index)){
                    cases_3.push(data);
                }else if (!data){
                    return;
                }
                $("."+index).text(data);
            });
            $(".2_1_countries").text(cases_3.join("、"));
            text = $(".text_to_save").text();
        }
    });

    d3.csv("{% static export_dir|add:'2-1.csv' %}", function (error, csvdata) {
        if(error){
            console.log(error);
        }else{
            worldMap(csvdata, '累计确诊人数', '2_1', $(".7").text().replace(/,/g,""));
        }
    });

    d3.csv("{% static export_dir|add:'2-2.csv' %}", function (error, csvdata) {
        if(error){
            console.log(error);
        }else{
            worldMap(csvdata, '累计病死人数', '2_2', $(".11").text().replace(/,/g,""));
        }
    });

    d3.csv("{% static export_dir|add:'2-3-a.csv' %}", function (error, csvdata) {
        if(error){
            console.log(error);
        }else{
            linechart_num(csvdata, "2_3_a")
        }
    });

    d3.csv("{% static export_dir|add:'2-3-b.csv' %}", function (error, csvdata) {
        if(error){
            console.log(error);
        }else{
            linechart_num(csvdata, "2_3_b")
        }
    });

    d3.csv("{% static export_dir|add:'2-4-a.csv' %}", function (error, csvdata) {
        if(error){
            console.log(error);
        }else{
            linechart_rate(csvdata, "2_4_a")
        }
    });

    d3.csv("{% static export_dir|add:'2-4-b.csv' %}", function (error, csvdata) {
        if(error){
            console.log(error);
        }else{
            linechart_rate(csvdata, "2_4_b")
        }
    });
    

    d3.csv("{% static export_dir|add:'2-6.csv' %}", function (error, csvdata) {
        if(error){
            console.log(error);
        }else{
            // console.log(csvdata);
            pieChart(csvdata, "累计确诊人数", "2_6");
        }
    });

    d3.csv("{% static export_dir|add:'2-7.csv' %}", function (error, csvdata) {
        if(error){
            console.log(error);
        }else{
            // console.log(csvdata);
            pieChart(csvdata, "累计病死人数", "2_7");
        }
    });

    d3.csv("{% static export_dir|add:'2-14.csv' %}", function (error, csvdata) {
        if(error){
            console.log(error);
        }else{
            // console.log(csvdata);
            pieChart(csvdata, "本周新增确诊人数", "2_14");
        }
    });

    d3.csv("{% static export_dir|add:'2-15.csv' %}", function (error, csvdata) {
        if(error){
            console.log(error);
        }else{
            // console.log(csvdata);
            pieChart(csvdata, "本周新增病死人数", "2_15");
        }
    });

    d3.csv("{% static export_dir|add:'2-8.csv' %}", function (error, csvdata) {
        if(error){
            console.log(error);
        }else{
            barchart(csvdata.slice(0,51), "确诊率", '2_8');
        }
    });

    d3.csv("{% static export_dir|add:'2-9.csv' %}", function (error, csvdata) {
        if(error){
            console.log(error);
        }else{
            barchart(csvdata.slice(0,51), "病死率", '2_9');
        }
    });
    d3.csv("{% static export_dir|add:'2-10.csv' %}", function (error, csvdata) {
        if(error){
            console.log(error);
        }else{
            barchart(csvdata.slice(0,51), "治愈率", '2_10');
        }
    });
    d3.csv("{% static export_dir|add:'2-11.csv' %}", function (error, csvdata) {
        if(error){
            console.log(error);
        }else{
            barchart(csvdata.slice(0,51), "检测率", '2_11');
        }
    });

    d3.csv("{% static export_dir|add:'2-12.csv' %}", function (error, csvdata) {
        if(error){
            console.log(error);
        }else{
            barchart(csvdata.slice(0,51), "阳性率", '2_12');
        }
    });

    d3.csv("{% static export_dir|add:'2-13-a.csv' %}", function (error, csvdata) {
        if(error){
            console.log(error);
        }else{
            linechart_num_week(csvdata, '2_13_a');
        }
    });
    d3.csv("{% static export_dir|add:'2-13-b.csv' %}", function (error, csvdata) {
        if(error){
            console.log(error);
        }else{
            linechart_num_week(csvdata, '2_13_b');
        }
    });

    d3.csv("{% static export_dir|add:'2-16.csv' %}", function (error, csvdata) {
        if(error){
            console.log(error);
        }else{
            rate_countries_num += bi_directional_barchart(csvdata, "本周较上周新增确诊人数增速", "2_16", 0.2);
        }
    });

    d3.csv("{% static export_dir|add:'2-17.csv' %}", function (error, csvdata) {
        if(error){
            console.log(error);
        }else{
            rate_countries_num += bi_directional_barchart(csvdata, "本周较上周新增病死人数增速", "2_17", 0.1);
        }
    });

    d3.csv("{% static export_dir|add:'2-5-a.csv' %}", function (error, csvdata) {
        if(error){
            console.log(error);
        }else{
            linechart_num(csvdata, "2_5_a")
        }
    });
    d3.csv("{% static export_dir|add:'2-5-b.csv' %}", function (error, csvdata) {
        if(error){
            console.log(error);
        }else{
            linechart_num(csvdata, "2_5_b")
        }
    });

    d3.csv("{% static export_dir|add:'2-18.csv' %}", function (error, csvdata) {
        if(error){
            console.log(error);
        }else{
            barchart_num(csvdata.slice(0,50), "累计检测数", '2_18', [200000000, 50000000]);
        }
    });

    d3.csv("{% static export_dir|add:'2-19.csv' %}", function (error, csvdata) {
        if(error){
            console.log(error);
        }else{
            bi_yAxis_barchart(csvdata, "全球（215个国家地区合计）", '2_19', [350000, 420000, 70000]);
        }
    });

    d3.csv("{% static export_dir|add:'2-20.csv' %}", function (error, csvdata) {
        if(error){
            console.log(error);
        }else{
            bi_yAxis_barchart(csvdata, "“一带一路”国家（65个国家地区合计）", '2_20', [150000, 150000, 30000]);
        }
    });

    d3.csv("{% static export_dir|add:'2-21.csv' %}", function (error, csvdata) {
        if(error){
            console.log(error);
        }else{
            bi_yAxis_barchart(csvdata, "非洲国家（52个国家地区合计）", '2_21', [25000, 35000, 5000]);
        }
    });

    d3.csv("{% static export_dir|add:'2-22.csv' %}", function (error, csvdata) {
        if(error){
            console.log(error);
        }else{
            bi_yAxis_barchart(csvdata, '周边国家（20个国家地区合计）', '2_22', [120000, 120000, 20000]);
        }
    });

    d3.csv("{% static export_dir|add:'2-23.csv' %}", function (error, csvdata) {
        if(error){
            console.log(error);
        }else{
            bi_yAxis_barchart(csvdata, "4月底处于上行阶段26个国家的合计数据", '2_23', [200000, 300000, 50000]);
        }
    });

    d3.csv("{% static export_dir|add:'2-24.csv' %}", function (error, csvdata) {
        if(error){
            console.log(error);
        }else{
            bi_yAxis_barchart(csvdata, "4月底处于震荡阶段28个国家的合计数据", '2_24', [40000, 70000, 10000]);
        }
    });

    d3.csv("{% static export_dir|add:'2-25.csv' %}", function (error, csvdata) {
        if(error){
            console.log(error);
        }else{
            bi_yAxis_barchart(csvdata, "4月底处于下行阶段28个国家的合计数据", '2_25', [150000, 120000, 30000]);
        }
    });

    d3.csv("{% static export_dir|add:'2-26.csv' %}", function (error, csvdata) {
        if(error){
            console.log(error);
        }else{
            bi_yAxis_barchart(csvdata, "4月底处于尾期阶段27个国家的合计数据", '2_26', [16000, 16000, 4000]);
        }
    });

    var flag = true;
    var loading = Ladda.create($("#create_btn")[0]);
    function createReport() {
        if (flag){
            loading.start();
            $.post('{% url "saveImage" %}',{'baseimg': JSON.stringify(imagesInfo), 'text': text, 'num': rate_countries_num},function (result, statue) {  //JSON.stringify({'2_5':imagesInfo['2_5']})
                if (!result.result){
                    alert(result.error);
                }else {
                    // alert("周报生成成功！");
                    $("#download")[0].click();
                    // flag = false;
                }
                loading.stop();
            });
        }else{
            $("#download")[0].click();
        }
    }

    function showMissingCountries() {
        if (countries.length || ineffectiveCountries.length){
            alert(alertInfo);
        }else{
            alert("暂无缺失国家");
        }
        if (error_info){
            alert(error_info);
        }
    }

    function deleteFiles() {
        $.get('{% url "deleteFiles" %}', function(result, statue){
            if (result.error){
                alert("删除过程中出现错误！\n" + result.error);
            }else{
                alert("删除成功！");
                // location.reload();
                location.href="/report";
            }
        })
    }
    
    function refresh_charts() {
        d3.csv("{% static export_dir|add:'2-16.csv' %}", function (error, csvdata) {
            if(error){
                console.log(error);
            }else{
                rate_countries_num += bi_directional_barchart(csvdata, "本周较上周新增确诊人数增速", "2_16", parseFloat($("#filter_cases").val()));
            }
        });

        d3.csv("{% static export_dir|add:'2-17.csv' %}", function (error, csvdata) {
            if(error){
                console.log(error);
            }else{
                rate_countries_num += bi_directional_barchart(csvdata, "本周较上周新增病死人数增速", "2_17", parseFloat($("#filter_death").val()));
                $("#after_refresh").removeClass("invisible");
                setTimeout(()=>{
                    $("#after_refresh").addClass("invisible");
                }, 3000);
            }
        });
    }
</script>
</body>
</html>